<!doctype html><html class="position-relative" itemscope itemtype="http://schema.org/WebPage" lang="zh-cn"
  
   data-palette="blue"
  >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>从0到1实现完整的微服务框架-用户服务 - 编程日记</title><link rel="apple-touch-icon" href="/images/icons/icon-180x180.png" sizes="180x180">
<link rel="icon" href="/images/icons/icon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/images/icons/icon-16x16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/images/icons/favicon.ico">
<link rel="manifest" href="/manifest.json">
<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

<meta name="keywords" content="" />
<meta name="description" content="本篇主要介绍实现用户服务中的相关内容。" /><meta name="robots" content="index, follow" /><meta itemprop="name" content="从0到1实现完整的微服务框架-用户服务">
<meta itemprop="description" content="本篇主要介绍实现用户服务中的相关内容。"><meta itemprop="datePublished" content="2022-03-25T20:42:57+00:00" />
<meta itemprop="dateModified" content="2022-03-25T20:42:57+00:00" />
<meta itemprop="wordCount" content="11106">
<meta itemprop="keywords" content="微服务,gRPC," /><meta property="og:title" content="从0到1实现完整的微服务框架-用户服务" />
<meta property="og:description" content="本篇主要介绍实现用户服务中的相关内容。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/dc2dadae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-25T20:42:57+00:00" />
<meta property="article:modified_time" content="2022-03-25T20:42:57+00:00" /><meta property="og:site_name" content="编程日记" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="从0到1实现完整的微服务框架-用户服务"/>
<meta name="twitter:description" content="本篇主要介绍实现用户服务中的相关内容。"/>
<meta property="og:image" content="/images/spider-man.jpg"/>
  <meta name="twitter:image" content="/images/spider-man.jpg"/><link rel="stylesheet" href="/assets/main/bundle.min.d09b7f7f687cbba5a0470808fba7973668726b909146fb392a44aa897b257a10.css" integrity="sha256-0Jt/f2h8u6WgRwgI+6eXNmhya5CRRvs5KkSqiXslehA=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/viewer/bundle.min.f05183267bb952fbc8c63a7178364de2951614ab71d544ec1068ad36c7447ccc.css" integrity="sha256-8FGDJnu5UvvIxjpxeDZN4pUWFKtx1UTsEGitNsdEfMw=" crossorigin="anonymous"></head>
  <body><script>const items=['mode','palette'];items.forEach(function(e){const t=localStorage.getItem('hbs-'+e);t&&document.body.parentElement.setAttribute('data-'+e,t)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href="/"><picture><img class="logo" alt="Logo" src="/images/spider-man.jpg" loading="lazy"
     width="556" height="559"
     />
</picture>
编程日记
    </a>
    <div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=%e4%bb%8e0%e5%88%b01%e5%ae%9e%e7%8e%b0%e5%ae%8c%e6%95%b4%e7%9a%84%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%a1%86%e6%9e%b6-%e7%94%a8%e6%88%b7%e6%9c%8d%e5%8a%a1&url=%2fposts%2fdc2dadae%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=%2fposts%2fdc2dadae%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>
    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">设置</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body d-flex flex-column">

<div class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> 模式</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</div>

<div class="setting">
  <form class="font-size-switcher-form row">
    <div class="col-auto">
      <label for="fontSize" class="form-label"><i class="fas fa-fw fa-font"></i> 字体大小</label>
    </div>
    <div class="col-auto ms-auto">
      <input type="range" class="form-range" min="-2" max="2" id="fontSize">
    </div>
  </form>
</div>


<div class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> 配色</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex justify-content-between visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="蓝色"
        class="btn btn-sm w-100 palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="蓝灰色"
        class="btn btn-sm w-100 palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="棕色"
        class="btn btn-sm w-100 palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="青色"
        class="btn btn-sm w-100 palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="绿色"
        class="btn btn-sm w-100 palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="靛青色"
        class="btn btn-sm w-100 palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="橙色"
        class="btn btn-sm w-100 palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="粉色"
        class="btn btn-sm w-100 palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="紫色"
        class="btn btn-sm w-100 palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="红色"
        class="btn btn-sm w-100 palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="蓝绿色"
        class="btn btn-sm w-100 palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="黄色"
        class="btn btn-sm w-100 palette" data-palette="yellow">
      </button></div>
</div>
<div class="setting actions d-flex justify-content-around mt-auto overflow-auto">
  <a role="button" class="action action-go-back" href="javascript: window.history.back();">
    <span class="action-icon"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform="rotate-90"></i></span> 返回
  </a>
  <a role="button" class="action action-reload-page">
    <span class="action-icon"><i class="fas fa-2x fa-redo-alt"></i></span> 刷新
  </a>
  <a role="button" class="action action-copy-url">
    <span class="action-icon"><i class="fas fa-2x fa-link"></i></span> 复制链接
  </a><a class="action action-social-share" role="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
    aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
    <span class="action-icon"><i class="fas fa-2x fa-share-alt"></i></span> 分享
  </a></div>

</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>
      <ul class="navbar-nav ms-auto"><li class="nav-item">
          <a class="nav-link" href="/series/">
            <i class="fas fa-fw fa-columns"></i>专栏
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/archives/">
            <i class="fas fa-fw fa-file-archive"></i>归档
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/categories/">
            <i class="fas fa-fw fa-folder"></i>分类
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/tags/">
            <i class="fas fa-fw fa-tags"></i>标签
          </a>
        </li><li class="nav-item dropdown">
          <a class="nav-link" id="navbarDropdownFriends" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-fw fa-chevron-circle-down"></i>友情链接
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownFriends"><li>
              <a class="dropdown-item"
                href="https://xieash.work/" target="_blank" rel="noopener noreferrer">
                xieash
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://sunnysab.cn/" target="_blank" rel="noopener noreferrer">
                sunnysab
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://wanfengcxz.cn/" target="_blank" rel="noopener noreferrer">
                wanfengcxz
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://zhangzqs.cn/" target="_blank" rel="noopener noreferrer">
                zhangzqs
              </a>
            </li></ul>
        </li><li class="nav-item">
          <a class="nav-link" href="/data">
            资料
          </a>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="/">主页</a></li><li class="breadcrumb-item"><a href="/posts/">Posts</a></li><li class="breadcrumb-item active">从0到1实现完整的微服务框架-用户服务</li></ol>
  </div>
</nav><div class="post-panel-wrapper position-sticky">
  <div class="d-flex flex-column component rounded post-panel position-absolute">
    
    <a class="action action-panel-toggler" role="button" title="Panel toggler">
      <i class="fas fa-fw fa-chevron-circle-down"></i>
    </a>
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button" title="Sidebar toggler">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>

    

    
    <a class="action" href="#post-copyright" role="button" aria-label="Copyright" title="Copyright">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    
    <a class="action" href="#postTOC" aria-controls="Table of contents" role="button" title="Table of contents">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    
  </div>
</div>
<article class="row card component mb-4 post">
  <div class="card-header ">
    <h1 class="card-title post-title">从0到1实现完整的微服务框架-用户服务
</h1>
  </div>
  <div class="card-body"><div class="post-meta">
  <span class="post-date" title="创建于 2022-03-26 04:42:57 &#43;0800 CST。">
    2022-03-25
  </span><span class="post-reading-time">
    23 分钟阅读
  </span><span class="post-taxonomies"><a href="/series/%E4%BB%8E0%E5%88%B01%E5%AE%9E%E7%8E%B0%E5%AE%8C%E6%95%B4%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/" class="badge post-taxonomy">从0到1实现完整的微服务框架</a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="badge post-taxonomy">微服务</a><a href="/tags/grpc/" class="badge post-taxonomy">gRPC</a></span>
</div>
<div class="post-content mb-3"><p>本篇主要介绍实现用户服务中的相关内容。</p>
<h2 id="开始">开始<a class="anchor ms-1" href="#开始"><i class="fas fa-link"></i></a></h2>
<p>新建项目</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">mkdir shop
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">cd</span> shop
</span></span><span class="line"><span class="ln">3</span><span class="cl">mkdir api,docs,service
</span></span></code></pre></div><p>本项目采用的是分层的微服务架构，api主要是对外提供的http接口，docs放相关的文档，service主要提供对内的grpc服务。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln"> 1</span><span class="cl">shop
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">├── api
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">│   └── user-api	// 用户服务的api
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">│       ├── api		// http接口
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">│       ├── config	// 相关配置文件的go内容
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">│       ├── global	// 全局变量 数据库连接
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">│       ├── initialize	// 初始化相关的
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">│       ├── middlewares	// 中间件
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">│       ├── proto	// proto文件
</span></span><span class="line"><span class="ln">10</span><span class="cl">│       ├── router	// 路由
</span></span><span class="line"><span class="ln">11</span><span class="cl">│       └── util
</span></span><span class="line"><span class="ln">12</span><span class="cl">│   
</span></span><span class="line"><span class="ln">13</span><span class="cl">├── docs
</span></span><span class="line"><span class="ln">14</span><span class="cl">│   └── service
</span></span><span class="line"><span class="ln">15</span><span class="cl">└── service
</span></span><span class="line"><span class="ln">16</span><span class="cl">    └── user_srv
</span></span><span class="line"><span class="ln">17</span><span class="cl">        ├── config	// 配置文件
</span></span><span class="line"><span class="ln">18</span><span class="cl">        ├── db		// 数据库相关的
</span></span><span class="line"><span class="ln">19</span><span class="cl">        │   ├── migration	// 数据库同步
</span></span><span class="line"><span class="ln">20</span><span class="cl">        │   └── query		// curd	的 SQL 语句
</span></span><span class="line"><span class="ln">21</span><span class="cl">        ├── global	// 全局变量
</span></span><span class="line"><span class="ln">22</span><span class="cl">        ├── handler	// 服务处理
</span></span><span class="line"><span class="ln">23</span><span class="cl">        ├── initialize
</span></span><span class="line"><span class="ln">24</span><span class="cl">        ├── model	// 数据库表结构对应的model
</span></span><span class="line"><span class="ln">25</span><span class="cl">        ├── proto	
</span></span><span class="line"><span class="ln">26</span><span class="cl">        └── util
</span></span></code></pre></div><h2 id="用户表结构">用户表结构<a class="anchor ms-1" href="#用户表结构"><i class="fas fa-link"></i></a></h2>
<p>进入<code>service/user_srv</code>初始化mod</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">go mod init github.com/jimyag/shop/service/user
</span></span></code></pre></div><p>用户信息中要包含一下信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="s2">&#34;id&#34;</span><span class="w">         </span><span class="n">bigserial</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 自增id
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;created_at&#34;</span><span class="w"> </span><span class="n">timestamptz</span><span class="w">    </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">()),</span><span class="w"> </span><span class="c1">-- 信息创建时间
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;updated_at&#34;</span><span class="w"> </span><span class="n">timestamptz</span><span class="w">    </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">()),</span><span class="w"> </span><span class="c1">-- 信息修改时间
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;deleted_at&#34;</span><span class="w"> </span><span class="n">timestamptz</span><span class="w">             </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 信息删除时间， 这是的删除使用的是软删除，只是给用户信息打个标记，提示该用户已经被删除了
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;email&#34;</span><span class="w">      </span><span class="nb">varchar</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">	</span><span class="c1">-- 邮件
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;password&#34;</span><span class="w">   </span><span class="nb">varchar</span><span class="w">        </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">	</span><span class="c1">-- 密码
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;nickname&#34;</span><span class="w">   </span><span class="nb">varchar</span><span class="w">        </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">	</span><span class="c1">-- 昵称
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;gender&#34;</span><span class="w">     </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">     </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;male&#39;</span><span class="p">,</span><span class="w">	</span><span class="c1">-- 性别
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s2">&#34;role&#34;</span><span class="w">       </span><span class="nb">int8</span><span class="w">           </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="w">		</span><span class="c1">-- 权限
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w"> </span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">.</span><span class="s2">&#34;email&#34;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;user email&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">.</span><span class="s2">&#34;password&#34;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;user password&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">.</span><span class="s2">&#34;nickname&#34;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;user nickname default email&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">.</span><span class="s2">&#34;gender&#34;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;male man ,female women&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">.</span><span class="s2">&#34;role&#34;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;1 user 2 admin&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>进入<code>user-srv/db</code>文件，执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">migrate create -ext sql -dir migration -seq init_schema_user
</span></span><span class="line"><span class="ln">2</span><span class="cl">D:<span class="se">\r</span>epository<span class="se">\s</span>hop<span class="se">\s</span>ervice<span class="se">\u</span>ser_srv<span class="se">\d</span>b<span class="se">\m</span>igration<span class="se">\0</span>00001_init_schema_user.up.sql
</span></span><span class="line"><span class="ln">3</span><span class="cl">D:<span class="se">\r</span>epository<span class="se">\s</span>hop<span class="se">\s</span>ervice<span class="se">\u</span>ser_srv<span class="se">\d</span>b<span class="se">\m</span>igration<span class="se">\0</span>00001_init_schema_user.down.sql
</span></span></code></pre></div><p>生成同步表结构,</p>
<p>将上述的<code>sql</code>语句写入到<code>shop\service\user_srv\db\migration\000001_init_schema_user.up.sql</code>中，</p>
<p>在<code>shop\service\user_srv\db\migration\000001_init_schema_user.down.sql</code>中写入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">DROP TABLE IF EXISTS <span class="s2">&#34;user&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p><code>up</code>是用来同步数据库</p>
<p><code>down</code>是用来回滚数据库</p>
<h3 id="创建user数据库">创建user数据库<a class="anchor ms-1" href="#创建user数据库"><i class="fas fa-link"></i></a></h3>
<p>相关文档会在<code>docs</code>中进行更新，推荐保存下来用到的各个端口，以防后面冲突。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">docker run --name shop-user -p 35432:5432 -e <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>postgres -e <span class="nv">TZ</span><span class="o">=</span>PRC -d postgres:14-alpine
</span></span></code></pre></div><p>创建用户数据库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">docker <span class="nb">exec</span> -it shop-user createdb --username<span class="o">=</span>postgres --owner<span class="o">=</span>postgres shop
</span></span></code></pre></div><p>删除用户数据库的命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">docker <span class="nb">exec</span> -it shop-user dropdb  --username<span class="o">=</span>postgres shop
</span></span></code></pre></div><h3 id="数据库迁移">数据库迁移<a class="anchor ms-1" href="#数据库迁移"><i class="fas fa-link"></i></a></h3>
<p>生成用户表，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">migrate -path db/migration -database <span class="s2">&#34;postgresql://postgres:postgres@localhost:35432/shop?sslmode=disable&#34;</span> -verbose up
</span></span></code></pre></div><p>删除用户表，（如果可以用到的话）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">migrate -path db/migration -database <span class="s2">&#34;postgresql://postgres:postgres@localhost:35432/shop?sslmode=disable&#34;</span> -verbose down
</span></span></code></pre></div><h3 id="生成curd代码">生成curd代码<a class="anchor ms-1" href="#生成curd代码"><i class="fas fa-link"></i></a></h3>
<p>在wsl中 初始化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">docker run --rm -v /mnt/d/repository/shop/service/user_srv:/src -w /src kjconroy/sqlc init
</span></span></code></pre></div><p>在生成的<code>sqlc.yaml</code>中写入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;./model&#34;</span><span class="w"> </span><span class="c"># 生成go 代码的位置</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;model&#34;</span><span class="w">  </span><span class="c"># 生成 go package 的名字</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">engine</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;postgresql&#34;</span><span class="w"> </span><span class="c"># 使用的数据库引擎</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">schema</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;./db/migration/&#34;</span><span class="w"> </span><span class="c"># 迁移表的sql语句 我们使用migrate中的up文件</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">queries</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;./db/query&#34;</span><span class="w"> </span><span class="c"># CRUD的sql</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">emit_json_tags</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># 添加json在生成的struct中</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">emit_prepared_queries</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">emit_interface</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 生成接口</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">emit_exact_table_names</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># 表名是否带s</span><span class="w">
</span></span></span></code></pre></div><p>在<code>shop\service\user_srv\db\query\user.sql</code>curd的SQL语句</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">-- name: CreateUser :one
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">                   </span><span class="n">password</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">                   </span><span class="n">nickname</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">                   </span><span class="n">gender</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">                   </span><span class="k">role</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="mi">5</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">returning</span><span class="w"> </span><span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">-- name: GetUserById :one
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">-- name: GetUserByEmail :one
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="c1">-- name: ListUsers :many
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">deleted_at</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="k">limit</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="k">offset</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="c1">-- name: DeleteUser :execrows
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span><span class="k">update</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">deleted_at</span><span class="w"> </span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">deleted_at</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w"></span><span class="c1">-- name: UpdateUser :one
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="c1"></span><span class="k">update</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="n">nickname</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="n">gender</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="k">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">4</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="n">password</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">5</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">6</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="n">returning</span><span class="w"> </span><span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>生成curd代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">docker run --rm -v /mnt/d/repository/shop/service/user_srv:/src -w /src kjconroy/sqlc generate
</span></span></code></pre></div><p>这里的<code>/mnt/d/repository/shop/service/user_srv</code>是我当前项目的所在的位置</p>
<p>这时，会在<code>shop\service\user_srv\model</code>中生成四个文件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">├── db.go
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── models.go
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── querier.go
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── user.sql.go
</span></span></code></pre></div><h3 id="测试连接数据库">测试连接数据库<a class="anchor ms-1" href="#测试连接数据库"><i class="fas fa-link"></i></a></h3>
<p>在<code>shop\service\user_srv\model</code>新建文件夹<code>main/main.go</code></p>
<p><code>shop\service\user_srv\model\main\main.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/lib/pq&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/model&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nx">DbDriver</span> <span class="p">=</span> <span class="s">&#34;postgres&#34;</span> <span class="c1">// 数据库的驱动
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"></span>	<span class="nx">DbSource</span> <span class="p">=</span> <span class="s">&#34;postgresql://postgres:postgres@localhost:35432/shop?sslmode=disable&#34;</span> <span class="c1">// 数据库的链接
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>    <span class="c1">// 驱动://用户名:密码@数据库的地址:端口号/数据库名称？sslmode=disable   
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">DbDriver</span><span class="p">,</span> <span class="nx">DbSource</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="s">&#34;cannot connect to db :&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;connect db ....&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="nx">sqlStore</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nf">NewSqlStore</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlStore</span><span class="p">.</span><span class="nf">GetUserByEmail</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;jimyag1@126.com&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="测试生成的curd代码">测试生成的curd代码<a class="anchor ms-1" href="#测试生成的curd代码"><i class="fas fa-link"></i></a></h3>
<p>在<code>shop\service\user_srv\model</code>新建两个文件，<code>main_test.go</code>,<code>user.sql_test.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">.
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── db.go
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── main
</span></span><span class="line"><span class="ln">4</span><span class="cl">│   └── main.go
</span></span><span class="line"><span class="ln">5</span><span class="cl">├── main_test.go
</span></span><span class="line"><span class="ln">6</span><span class="cl">├── models.go
</span></span><span class="line"><span class="ln">7</span><span class="cl">├── querier.go
</span></span><span class="line"><span class="ln">8</span><span class="cl">├── user.sql.go
</span></span><span class="line"><span class="ln">9</span><span class="cl">└── user.sql_test.go
</span></span></code></pre></div><p>这两个是为了测试生成的curd代码是否正确。</p>
<p><code>shop/service/user_srv/model/main_test.go</code>中添加一下内容，这里是一个main测试，在当前包中所有的测试之前都会执行这个方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">model</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/lib/pq&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="nx">DbDriver</span> <span class="p">=</span> <span class="s">&#34;postgres&#34;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nx">DbSource</span> <span class="p">=</span> <span class="s">&#34;postgresql://postgres:postgres@localhost:35432/shop?sslmode=disable&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nx">testQueries</span> <span class="o">*</span><span class="nx">Queries</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="nx">testDB</span>      <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="kd">func</span> <span class="nf">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="nx">testDB</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">DbDriver</span><span class="p">,</span> <span class="nx">DbSource</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="s">&#34;cannot connect to db :&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">testQueries</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">testDB</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;connect db success....&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">	<span class="c1">// m.Run() 返回一个退出的代码，告诉我们测试是否通过
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span>	<span class="c1">// 使用 os.Exit() 将测试的结果报告给测试运行程序
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="c1"></span>	<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nf">Run</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>为了测试随机生成相关的用户名密码性别，我们可以创建一个测试的工具包<code>shop\service\user_srv\util\test_util\test_util.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">test_util</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;crypto/sha512&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;github.com/anaskhan96/go-password-encoder&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nx">alphabet</span> <span class="p">=</span> <span class="s">&#34;abcdefghijklmopqrstuvwxyz&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nx">Options</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">password</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">SaltLen</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">Iterations</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">KeyLen</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="nx">HashFunction</span><span class="p">:</span> <span class="nx">sha512</span><span class="p">.</span><span class="nx">New</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="c1">// 设置随机数种子
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span>	<span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="kd">func</span> <span class="nf">RandomString</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="kd">var</span> <span class="nx">sb</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Builder</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">k</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">alphabet</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">		<span class="nx">c</span> <span class="o">:=</span> <span class="nx">alphabet</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">k</span><span class="p">)]</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="nx">sb</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="k">return</span> <span class="nx">sb</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="kd">func</span> <span class="nf">RandomInt</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">	<span class="k">return</span> <span class="nx">min</span> <span class="o">+</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int63n</span><span class="p">(</span><span class="nx">max</span><span class="o">-</span><span class="nx">min</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="kd">func</span> <span class="nf">RandomEmail</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;jimyag%s@126.com&#34;</span><span class="p">,</span> <span class="nf">RandomString</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="kd">type</span> <span class="nx">Password</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="nx">RawPassword</span>       <span class="kt">string</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">	<span class="nx">Slat</span>              <span class="kt">string</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">	<span class="nx">EncryptedPassword</span> <span class="kt">string</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="kd">func</span> <span class="nf">RandomPassword</span><span class="p">()</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">Password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">	<span class="nx">rawPassword</span> <span class="o">:=</span> <span class="nf">RandomString</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">	<span class="nx">slat</span><span class="p">,</span> <span class="nx">encryptedPassword</span> <span class="o">:=</span> <span class="nx">password</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rawPassword</span><span class="p">,</span> <span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">	<span class="nx">p</span> <span class="p">=</span> <span class="nx">Password</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">		<span class="nx">RawPassword</span><span class="p">:</span>       <span class="nx">rawPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">		<span class="nx">Slat</span><span class="p">:</span>              <span class="nx">slat</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">		<span class="nx">EncryptedPassword</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;$pbkdf2-sha512$%s$%s&#34;</span><span class="p">,</span> <span class="nx">slat</span><span class="p">,</span> <span class="nx">encryptedPassword</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">
</span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="kd">func</span> <span class="nf">RandomNickName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;jimyag%s&#34;</span><span class="p">,</span> <span class="nf">RandomString</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">
</span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="kd">func</span> <span class="nf">RandomGender</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">	<span class="nx">gender</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;male&#34;</span><span class="p">,</span> <span class="s">&#34;female&#34;</span><span class="p">,</span> <span class="s">&#34;middle&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">	<span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">gender</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">	<span class="k">return</span> <span class="nx">gender</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这里随机生成的<code>password</code>我们之后再做说明。</p>
<p>在<code>shop\service\user_srv\model\user.sql_test.go</code>添加，执行测试。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">model</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/stretchr/testify/require&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/util/test_util&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="kd">func</span> <span class="nf">createRandomUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">test_util</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomPassword</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="nx">arg</span> <span class="o">:=</span> <span class="nx">CreateUserParams</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		<span class="nx">Email</span><span class="p">:</span>    <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomEmail</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">EncryptedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span> <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomNickName</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="nx">Gender</span><span class="p">:</span>   <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomGender</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>     <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">testQueries</span><span class="p">.</span><span class="nf">CreateUser</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NotEmpty</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Email</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Role</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Role</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Gender</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Gender</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Nickname</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Nickname</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NotZero</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NotZero</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NotZero</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">UpdatedAt</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="k">return</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">p</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="kd">func</span> <span class="nf">TestQueries_CreateUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">	<span class="nx">user</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">createRandomUser</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">	<span class="nx">arg</span> <span class="o">:=</span> <span class="nx">CreateUserParams</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">		<span class="nx">Email</span><span class="p">:</span>    <span class="nx">user</span><span class="p">.</span><span class="nx">Email</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">		<span class="nx">Gender</span><span class="p">:</span>   <span class="nx">user</span><span class="p">.</span><span class="nx">Gender</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>     <span class="nx">user</span><span class="p">.</span><span class="nx">Role</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">	<span class="c1">// 再次创建用户会失败
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="c1"></span>	<span class="nx">newUser</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">testQueries</span><span class="p">.</span><span class="nf">CreateUser</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Empty</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">newUser</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="o">...</span> <span class="nx">其余详细的测试代码见</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/blob/master/service/user_srv/model/user.sql_test.go
</span></span></span></code></pre></div><p>到这里我们数据库方面的都已经测试好了。</p>
<h3 id="关于用户密码的加密">关于用户密码的加密<a class="anchor ms-1" href="#关于用户密码的加密"><i class="fas fa-link"></i></a></h3>
<p>我们使用一个随机的盐并加密用户的密码，在保存用户密码时，可以保存加密的算法，盐值、加密后的密码。例如</p>
<p><code>$pbkdf2-sha512$ScHj3WqUbGWBx0i5$a777173035ac06d8557b603593b49d26961c4cd1d2adaeff</code></p>
<p>并且这几个要用特殊的标志分隔开。</p>
<p>这样可以保证每一个用户的盐都是随机的，生成的密码更安全。</p>
<h2 id="定义用户proto">定义用户proto<a class="anchor ms-1" href="#定义用户proto"><i class="fas fa-link"></i></a></h2>
<p>在<code>shop\service\user_srv\proto</code>中新建<code>user.proto</code>文件，并写入以下内容。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="err"></span><span class="k">option</span> <span class="n">go_package</span> <span class="o">=</span> <span class="s">&#34;.;proto&#34;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="err"></span><span class="kd">service</span> <span class="n">User</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="err"></span>  <span class="k">rpc</span> <span class="n">GetUserList</span><span class="p">(</span><span class="n">PageIngo</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">UserListResponse</span><span class="p">){};</span> <span class="c1">// 获得用户列表
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"></span>  <span class="k">rpc</span> <span class="n">GetUserByEmail</span><span class="p">(</span><span class="n">EmailRequest</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">UserInfoResponse</span><span class="p">){};</span> <span class="c1">// 使用邮箱获得用户信息
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1"></span>  <span class="k">rpc</span> <span class="n">GetUserById</span><span class="p">(</span><span class="n">IdRequest</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">UserInfoResponse</span><span class="p">){};</span> <span class="c1">// 使用Id获得用户信息
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span>  <span class="k">rpc</span> <span class="n">CreateUser</span><span class="p">(</span><span class="n">CreateUserRequest</span><span class="p">)</span><span class="k">returns</span><span class="p">(</span><span class="n">UserInfoResponse</span><span class="p">){};</span> <span class="c1">// 添加用户
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span>  <span class="k">rpc</span> <span class="n">UpdateUser</span><span class="p">(</span><span class="n">UpdateUserRequest</span><span class="p">)</span><span class="k">returns</span><span class="p">(</span><span class="n">UserInfoResponse</span><span class="p">){};</span> <span class="c1">// 更新用户信息
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span>  <span class="k">rpc</span> <span class="n">CheckPassword</span><span class="p">(</span><span class="n">PasswordCheckInfo</span><span class="p">)</span> <span class="k">returns</span><span class="p">(</span><span class="n">CheckPasswordResponse</span><span class="p">){};</span> <span class="c1">//检查用户密码
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">PasswordCheckInfo</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">password</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">encryptedPassword</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">CheckPasswordResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="err"></span>  <span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">UpdateUserRequest</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">email</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">password</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">nickname</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">gender</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">role</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">CreateUserRequest</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">email</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">password</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">nickname</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">gender</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">role</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">EmailRequest</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">email</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">IdRequest</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="err"></span>  <span class="kt">uint32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">PageIngo</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="err"></span>  <span class="kt">uint32</span> <span class="n">pageNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="err"></span>  <span class="kt">uint32</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">UserInfoResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">created_at</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">updated_at</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">email</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">password</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">nickname</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">gender</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">role</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">UserListResponse</span><span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="err"></span>  <span class="k">repeated</span> <span class="n">UserInfoResponse</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>生成用户的pb文件。在<code>shop\service\user_srv\proto</code>中执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln">1</span><span class="cl">protoc -I . user.proto --go_out<span class="o">=</span><span class="nv">plugins</span><span class="o">=</span>grpc:.
</span></span></code></pre></div><p>即可在当前文件夹(<code>shop\service\user_srv\proto</code>)下生成<code>user.pb.go</code></p>
<p><code>user.pb.go</code>的文件中，有server和client要实现的接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// client 要实现的接口
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">UserClient</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	<span class="nf">GetUserList</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">PageIngo</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserListResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="nf">GetUserByEmail</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">EmailRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="nf">GetUserById</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">IdRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">CreateUserRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="nf">UpdateUser</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">UpdateUserRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="nf">CheckPassword</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">PasswordCheckInfo</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CheckPasswordResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">// server要实现的接口
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1">// UserServer is the server API for User service.
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">UserServer</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="nf">GetUserList</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">PageIngo</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserListResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nf">GetUserByEmail</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">EmailRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="nf">GetUserById</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">IdRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="nf">CreateUser</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">CreateUserRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nf">UpdateUser</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">UpdateUserRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nf">CheckPassword</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">PasswordCheckInfo</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CheckPasswordResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="实现grpc用户的相关接口">实现grpc用户的相关接口<a class="anchor ms-1" href="#实现grpc用户的相关接口"><i class="fas fa-link"></i></a></h2>
<p>在实现grpc生成的用户接口之前，我们首先封装数据库。</p>
<p>在<code>shop\service\user_srv\model</code>新建<code>store.go</code>文件，</p>
<p>定义一个store的接口，这个是方便之后实现不同的存储。可以使用内存做存储，也可以使用数据库，当然我们这里使用的是数据库做存储。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">type</span> <span class="nx">Store</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">	<span class="nf">CreateUserTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">arg</span> <span class="nx">CreateUserParams</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">	<span class="nf">UpdateUserTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">arg</span> <span class="nx">UpdateUserParams</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">	<span class="nx">Querier</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>CreateUserTx</code>和<code>UpdateUserTx</code>对应的是创建用户和更新用户的事务，在此过程要执行多个SQL操作，我们用事务进行封装。</p>
<p><code>Querier</code>是生成curd的接口。</p>
<p>定义一个SQLstore，并且实现store的接口，代码如下，完整的代码见<a href="https://github.com/jimyag/shop/blob/master/service/user_srv/model/store.go" target="_blank" rel="noopener noreferrer">store.go)</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">model</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">   <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">   <span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">   <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">   <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">   <span class="s">&#34;google.golang.org/grpc/codes&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">   <span class="s">&#34;google.golang.org/grpc/status&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kd">type</span> <span class="nx">Store</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">   <span class="nf">CreateUserTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">arg</span> <span class="nx">CreateUserParams</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">   <span class="nf">UpdateUserTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">arg</span> <span class="nx">UpdateUserParams</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">   <span class="nx">Querier</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="kd">type</span> <span class="nx">SqlStore</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">   <span class="o">*</span><span class="nx">Queries</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">   <span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="kd">func</span> <span class="nf">NewSqlStore</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">Store</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">   <span class="k">return</span> <span class="o">&amp;</span><span class="nx">SqlStore</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">      <span class="nx">Queries</span><span class="p">:</span> <span class="nf">New</span><span class="p">(</span><span class="nx">db</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">      <span class="nx">db</span><span class="p">:</span>      <span class="nx">db</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1">// 这是一个执行事务的方法，如果在执行中遇到错误，会自动回滚。
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">store</span> <span class="o">*</span><span class="nx">SqlStore</span><span class="p">)</span> <span class="nf">execTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">queries</span> <span class="o">*</span><span class="nx">Queries</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">   <span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">BeginTx</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">      <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">   <span class="nx">q</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">   <span class="nx">err</span> <span class="p">=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">      <span class="k">if</span> <span class="nx">rbErr</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">();</span> <span class="nx">rbErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">         <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;tx err: %v, rb err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">rbErr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">      <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl">   <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Commit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">store</span> <span class="o">*</span><span class="nx">SqlStore</span><span class="p">)</span> <span class="nf">CreateUserTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">arg</span> <span class="nx">CreateUserParams</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">	<span class="o">...</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/blob/master/service/user_srv/model/store.go
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">store</span> <span class="o">*</span><span class="nx">SqlStore</span><span class="p">)</span> <span class="nf">UpdateUserTx</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">arg</span> <span class="nx">UpdateUserParams</span><span class="p">)</span> <span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="o">...</span><span class="p">.</span> <span class="nx">省略</span><span class="err">，</span><span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/blob/master/service/user_srv/model/store.go
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h3 id="实现grpc的接口">实现grpc的接口<a class="anchor ms-1" href="#实现grpc的接口"><i class="fas fa-link"></i></a></h3>
<p>实现grpc时，我们需要一个结构体<code>UserServer</code>，在实现这些接口的时候，我们需要用到<code>数据库</code>相关的操作，还还记得我们之前封装的接口<code>Store</code>嘛，这时候，就可以把它匿名传入。</p>
<p>在<code>shop\service\user_srv\handler</code>中新建文件<code>user.go</code>并写入一下内容grpc的接口，这边只实现一个稍微复杂的，其余的可以参考这个复杂的或者在<a href="https://github.com/jimyag/shop/blob/master/service/user_srv/handler/user.go" target="_blank" rel="noopener noreferrer">shop/user.go </a>中查看。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;crypto/sha512&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/anaskhan96/go-password-encoder&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;github.com/opentracing/opentracing-go&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc/codes&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc/status&#34;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/model&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/proto&#34;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="kd">type</span> <span class="nx">UserServer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="nx">model</span><span class="p">.</span><span class="nx">Store</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1">// 将userModel转换为UserInfo的响应
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">userModel2UserInfoResponse</span><span class="p">(</span><span class="nx">user</span> <span class="nx">model</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">		<span class="nx">Id</span><span class="p">:</span>        <span class="nb">int32</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">		<span class="nx">CreatedAt</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">.</span><span class="nf">Unix</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">		<span class="nx">UpdatedAt</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">UpdatedAt</span><span class="p">.</span><span class="nf">Unix</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">		<span class="nx">Email</span><span class="p">:</span>     <span class="nx">user</span><span class="p">.</span><span class="nx">Email</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span>  <span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span>  <span class="nx">user</span><span class="p">.</span><span class="nx">Nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">		<span class="nx">Gender</span><span class="p">:</span>    <span class="nx">user</span><span class="p">.</span><span class="nx">Gender</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>      <span class="nb">int32</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Role</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserServer</span><span class="p">)</span> <span class="nf">GetUserList</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">PageIngo</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserListResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="o">...</span><span class="p">.</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserServer</span><span class="p">)</span> <span class="nf">GetUserByEmail</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">EmailRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserServer</span><span class="p">)</span> <span class="nf">GetUserById</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">IdRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserServer</span><span class="p">)</span> <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">CreateUserRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserServer</span><span class="p">)</span> <span class="nf">UpdateUser</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UpdateUserRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">    <span class="c1">// 拿到请求过来的信息，组成更新用户的参数
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="c1"></span>	<span class="nx">arg</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">UpdateUserParams</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">		<span class="nx">UpdatedAt</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span>  <span class="nx">req</span><span class="p">.</span><span class="nf">GetNickname</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">		<span class="nx">Gender</span><span class="p">:</span>    <span class="nx">req</span><span class="p">.</span><span class="nf">GetGender</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>      <span class="nb">int64</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nf">GetRole</span><span class="p">()),</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span>  <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">		<span class="nx">ID</span><span class="p">:</span>        <span class="nb">int64</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Id</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">    <span class="c1">// 执行更新用户的事务，如果有错误就返回相应的错误。
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="c1"></span>	<span class="c1">// 已经处理过错误了
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="c1"></span>	<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Store</span><span class="p">.</span><span class="nf">UpdateUserTx</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">    <span class="c1">// 如果没有错所谓就将响应返回
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="c1"></span>	<span class="nx">rsp</span> <span class="o">:=</span> <span class="nf">userModel2UserInfoResponse</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">	<span class="k">return</span> <span class="nx">rsp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserServer</span><span class="p">)</span> <span class="nf">CheckPassword</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">PasswordCheckInfo</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">CheckPasswordResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">	<span class="nx">options</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">password</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">SaltLen</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">Iterations</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">KeyLen</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="nx">HashFunction</span><span class="p">:</span> <span class="nx">sha512</span><span class="p">.</span><span class="nx">New</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">	<span class="nx">encryptedPasswordInfo</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nf">GetEncryptedPassword</span><span class="p">(),</span> <span class="s">&#34;$&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">	<span class="nx">check</span> <span class="o">:=</span> <span class="nx">password</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span> <span class="nx">encryptedPasswordInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">encryptedPasswordInfo</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">proto</span><span class="p">.</span><span class="nx">CheckPasswordResponse</span><span class="p">{</span><span class="nx">Success</span><span class="p">:</span> <span class="nx">check</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="测试grpc接口">测试grpc接口<a class="anchor ms-1" href="#测试grpc接口"><i class="fas fa-link"></i></a></h3>
<p>在<code>shop\service\user_srv\main.go</code>创建一个服务端。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/golbal&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/handler&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/model&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/proto&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="c1">// 默认地址是本地地址:50051端口
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>	<span class="nx">IP</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;ip&#34;</span><span class="p">,</span> <span class="s">&#34;0.0.0.0&#34;</span><span class="p">,</span> <span class="s">&#34;ip地址&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nx">Port</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;port&#34;</span><span class="p">,</span> <span class="mi">50051</span><span class="p">,</span> <span class="s">&#34;端口号&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;server ready run %s:%d.....&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">IP</span><span class="p">,</span> <span class="o">*</span><span class="nx">Port</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="c1">// grpc的server
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span>	<span class="nx">server</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="nx">sqlStore</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nf">NewSqlStore</span><span class="p">(</span><span class="nx">golbal</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="c1">// user的server
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1"></span>	<span class="nx">userServer</span> <span class="o">:=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">UserServer</span><span class="p">{</span><span class="nx">Store</span><span class="p">:</span> <span class="nx">sqlStore</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="c1">// 将userServer注册到grpcServer上
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="c1"></span>	<span class="nx">proto</span><span class="p">.</span><span class="nf">RegisterUserServer</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">userServer</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="c1">// 监听端口
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span>	<span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%d&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">IP</span><span class="p">,</span> <span class="o">*</span><span class="nx">Port</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;cannot listen %s:%d.....\n&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">IP</span><span class="p">,</span> <span class="o">*</span><span class="nx">Port</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="c1">// server 启动
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;cannot run server.....&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;server running %s:%d.....&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">IP</span><span class="p">,</span> <span class="o">*</span><span class="nx">Port</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在<code>shop\service\user_srv\handler</code>新建两个grpc的测试文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/proto&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nx">userClient</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">UserClient</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nx">target</span> <span class="p">=</span> <span class="s">&#34;127.0.0.1:50051&#34;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="kd">func</span> <span class="nf">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;cannot dial %s :%v\n&#34;</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="nx">userClient</span> <span class="p">=</span> <span class="nx">proto</span><span class="p">.</span><span class="nf">NewUserClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;dial %s success....\n&#34;</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nf">Run</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;github.com/anaskhan96/go-password-encoder&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/stretchr/testify/require&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/proto&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/service/user/util/test_util&#34;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="kd">func</span> <span class="nf">createUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">proto</span><span class="p">.</span><span class="nx">UserInfoResponse</span><span class="p">,</span> <span class="nx">test_util</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomPassword</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">CreateUserRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="nx">Email</span><span class="p">:</span>    <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomEmail</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">EncryptedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span> <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomNickName</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">		<span class="nx">Gender</span><span class="p">:</span>   <span class="nx">test_util</span><span class="p">.</span><span class="nf">RandomGender</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>     <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userClient</span><span class="p">.</span><span class="nf">CreateUser</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">NotEmpty</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Email</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetEmail</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetPassword</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Nickname</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetNickname</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Gender</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetGender</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Role</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetRole</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">	<span class="k">return</span> <span class="nx">rsp</span><span class="p">,</span> <span class="nx">p</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="kd">func</span> <span class="nf">TestUserServer_CreateUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">	<span class="nx">rsp</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="nf">createUser</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">CreateUserRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">		<span class="nx">Email</span><span class="p">:</span>    <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetEmail</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">EncryptedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span> <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetNickname</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">		<span class="nx">Gender</span><span class="p">:</span>   <span class="nx">rsp</span><span class="p">.</span><span class="nf">GetGender</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>     <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="nx">newRsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userClient</span><span class="p">.</span><span class="nf">CreateUser</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Empty</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">newRsp</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="kd">func</span> <span class="nf">TestUserServer_GetUserById</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">    <span class="o">...</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/tree/master/service/user_srv/handler
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="kd">func</span> <span class="nf">TestUserServer_GetUserByEmail</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">	<span class="o">...</span><span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/tree/master/service/user_srv/handler
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="kd">func</span> <span class="nf">TestUserServer_GetUserList</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">	<span class="o">...</span><span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/tree/master/service/user_srv/handler
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">
</span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="kd">func</span> <span class="nf">TestUserServer_UpdateUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">	<span class="o">...</span><span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/tree/master/service/user_srv/handler
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">
</span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="kd">func</span> <span class="nf">TestUserServer_CheckPassword</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">	<span class="o">...</span><span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/jimyag/shop/tree/master/service/user_srv/handler
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>到这里grpc相关的逻辑就已经实现完了。</p>
<p>目前的目录结构如下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln"> 1</span><span class="cl">.
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">├── config
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">├── db
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">│   ├── migration
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">│   │   ├── 000001_init_schema_user.down.sql
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">│   │   └── 000001_init_schema_user.up.sql
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">│   └── query
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">│       └── user.sql
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">├── global
</span></span><span class="line"><span class="ln">10</span><span class="cl">├── go.mod
</span></span><span class="line"><span class="ln">11</span><span class="cl">├── go.sum
</span></span><span class="line"><span class="ln">12</span><span class="cl">├── handler
</span></span><span class="line"><span class="ln">13</span><span class="cl">│   ├── main_test.go
</span></span><span class="line"><span class="ln">14</span><span class="cl">│   ├── user.go
</span></span><span class="line"><span class="ln">15</span><span class="cl">│   └── user_test.go
</span></span><span class="line"><span class="ln">16</span><span class="cl">├── initialize
</span></span><span class="line"><span class="ln">17</span><span class="cl">├── main.go
</span></span><span class="line"><span class="ln">18</span><span class="cl">├── model
</span></span><span class="line"><span class="ln">19</span><span class="cl">│   ├── db.go
</span></span><span class="line"><span class="ln">20</span><span class="cl">│   ├── main
</span></span><span class="line"><span class="ln">21</span><span class="cl">│   │   └── main.go
</span></span><span class="line"><span class="ln">22</span><span class="cl">│   ├── main_test.go
</span></span><span class="line"><span class="ln">23</span><span class="cl">│   ├── models.go
</span></span><span class="line"><span class="ln">24</span><span class="cl">│   ├── querier.go
</span></span><span class="line"><span class="ln">25</span><span class="cl">│   ├── store.go
</span></span><span class="line"><span class="ln">26</span><span class="cl">│   ├── user.sql.go
</span></span><span class="line"><span class="ln">27</span><span class="cl">│   └── user.sql_test.go
</span></span><span class="line"><span class="ln">28</span><span class="cl">├── proto
</span></span><span class="line"><span class="ln">29</span><span class="cl">│   ├── user.pb.go
</span></span><span class="line"><span class="ln">30</span><span class="cl">│   └── user.proto
</span></span><span class="line"><span class="ln">31</span><span class="cl">├── sqlc.yaml
</span></span><span class="line"><span class="ln">32</span><span class="cl">└── util
</span></span><span class="line"><span class="ln">33</span><span class="cl">    └── test_util
</span></span><span class="line"><span class="ln">34</span><span class="cl">        └── test_util.go
</span></span></code></pre></div><h3 id="问题">问题<a class="anchor ms-1" href="#问题"><i class="fas fa-link"></i></a></h3>
<h4 id="设计一个通用的用户模型">设计一个通用的用户模型<a class="anchor ms-1" href="#设计一个通用的用户模型"><i class="fas fa-link"></i></a></h4>
<p>如果让你设计一个用户服务具备通用性，比如可以让所有的系统都可以公共代码?但是不同的系统在user表上可能会有不同的字段，如何设计表让系统具备通用性的同时还能具备好的扩展性?</p>
<h5 id="思路">思路<a class="anchor ms-1" href="#思路"><i class="fas fa-link"></i></a></h5>
<ol>
<li>基本上所有的系统用户都需要用户名和密码、登录时间等，这些可以设计成一张通用表。</li>
<li>如何可以扩展表并且不会对现有的表产生影响?</li>
</ol>
<h5 id="拓展">拓展<a class="anchor ms-1" href="#拓展"><i class="fas fa-link"></i></a></h5>
<p>扩展接口,比如将-整套的用户服务完善好, 把一整套的用户相关接口都自己实现好。</p>
<h4 id="设计一个生成基本service微服务脚手架">设计一个生成基本service微服务脚手架<a class="anchor ms-1" href="#设计一个生成基本service微服务脚手架"><i class="fas fa-link"></i></a></h4>
<p>自己写一个exe文件可以使得生成基本的service微服务脚手架，这个脚本可以在启动的时候让用户输入一些信息,你觉得有哪些信息可以通过用户输入进行配置?</p>
<ul>
<li>某些库可以选择。</li>
<li>选择注册中心</li>
</ul>
<h5 id="思路点拨">思路点拨<a class="anchor ms-1" href="#思路点拨"><i class="fas fa-link"></i></a></h5>
<ol>
<li>对于service和web端来说,两种代码的目录结构会不一致,所以该命令行可以支持两种类型。</li>
<li>比如后期可以考虑服务名称、否支持服务注册等都考虑进去</li>
</ol>
<h5 id="进一步思考">进一步思考<a class="anchor ms-1" href="#进一步思考"><i class="fas fa-link"></i></a></h5>
<p>命令行模式基本是微服务中必备的，go-micro和go-zero等解决方案都支持通过命令行生成模板目录,大家自
己也应该考虑后期处于维护的角度去长期维护这个脚本,随着以后自己的项目越来越完善，这个命令行业需要跟
着升级</p>
<h2 id="实现用户服务的web层服务">实现用户服务的web层服务<a class="anchor ms-1" href="#实现用户服务的web层服务"><i class="fas fa-link"></i></a></h2>
<p>用户<code>api</code>层的目录如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="ln"> 1</span><span class="cl">├── api
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">│   └── user-api	// 用户服务的api
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">│       ├── api		// http接口
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">│       ├── config	// 相关配置文件的go内容
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">│       ├── global	// 全局变量 数据库连接
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">│       ├── initialize	// 初始化相关的
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">│       ├── middlewares	// 中间件
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">│       ├── proto	// proto文件
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">│       ├── router	// 路由
</span></span><span class="line"><span class="ln">10</span><span class="cl">│       └── util
</span></span></code></pre></div><p>首先我们将之前<code>shop\service\user_srv\proto</code>文件夹中的文件<code>user.pb.go</code>和<code>user.proto</code>复制到<code>shop\api\user-api\proto</code>。这里把之前的proto文件复制过来是因为在客户端中还要继续使用proto文件中内容，这里有个问题就说如果api端修改了proto文件，那么grpc server端也要修改相应的proto文件。当然大家把api和srv放在一起也是可以的，这就要看个人的喜好了。其实把api和srv放在一起更好一点。</p>
<p>这个等我们再把第一个服务完成之后，我们会将这个两个合在一起。</p>
<h3 id="使用全局的zaplogger">使用全局的zaplogger<a class="anchor ms-1" href="#使用全局的zaplogger"><i class="fas fa-link"></i></a></h3>
<p>在global<code>shop\api\user-api\global\global.go</code>中定义全局的logger</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">package</span> <span class="nx">global</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="s">&#34;go.uber.org/zap&#34;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">    <span class="nx">Logger</span>           <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><h4 id="初始化logger">初始化logger<a class="anchor ms-1" href="#初始化logger"><i class="fas fa-link"></i></a></h4>
<p>在<code>shop\api\user-api\initialize\logger.go</code>初始化<code>global.Logger</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">initialize</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;go.uber.org/zap&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="kd">func</span> <span class="nf">InitLogger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProduction</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;初始化 logger 失败 :%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;初始化 logger 成功.....&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>之后就可以在在项目中使用<code>global.Logger</code>来打日志了。</p>
<h3 id="连接到grpc的服务端">连接到grpc的服务端<a class="anchor ms-1" href="#连接到grpc的服务端"><i class="fas fa-link"></i></a></h3>
<p>在global<code>shop\api\user-api\global\global.go</code>中定义全局的用户client</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">global</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="s">&#34;go.uber.org/zap&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/proto&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nx">Logger</span>           <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">UserSrvClient</span>    <span class="nx">proto</span><span class="p">.</span><span class="nx">UserClient</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><h4 id="初始化userclient">初始化userclient<a class="anchor ms-1" href="#初始化userclient"><i class="fas fa-link"></i></a></h4>
<p>在<code>shop\api\user-api\initialize\src_conn.go</code>中添加初始化userclient的代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">initialize</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;go.uber.org/zap&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/proto&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/util/otgrpc&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kd">func</span> <span class="nf">InitSrvConnOld1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="kd">var</span> <span class="nx">userSrvHost</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">&#34;localhost&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="kd">var</span> <span class="nx">userSrvPort</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">50051</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nx">userConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="nx">userSrvHost</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="nx">userSrvPort</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;用户服务连接失败&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;err&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="c1">// 已经事先建立好连接，后续就不用在此tcp三次握手
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"></span>	<span class="c1">// 一个连接多个gor 共用，grpc 的连接池
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1"></span>	<span class="c1">// todo 连接池
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1"></span>	<span class="nx">global</span><span class="p">.</span><span class="nx">UserSrvClient</span> <span class="p">=</span> <span class="nx">proto</span><span class="p">.</span><span class="nf">NewUserClient</span><span class="p">(</span><span class="nx">userConn</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="编写第一个http接口">编写第一个http接口<a class="anchor ms-1" href="#编写第一个http接口"><i class="fas fa-link"></i></a></h3>
<p>在<code>shop\api\user-api\api\user.go</code>中填写获得用户列表的接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">api</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc/codes&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc/status&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/proto&#34;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1">// 这里是用来grpc中的错误的
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">HandleGrpcErrorToHttp</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="c1">// 这里使用了grpc自己状态码，在grpc中不用我们自己维护状态码了
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">FromError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="k">switch</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Code</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">		<span class="k">case</span> <span class="nx">codes</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">			<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">				<span class="s">&#34;msg&#34;</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Message</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">		<span class="k">case</span> <span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">			<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">				<span class="s">&#34;msg&#34;</span><span class="p">:</span> <span class="s">&#34;内部错误&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">			<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">				<span class="s">&#34;msg&#34;</span><span class="p">:</span> <span class="s">&#34;未知错误&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="kd">func</span> <span class="nf">GetUserList</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="c1">// 写死的获得第一页的五个人的信息（从第一页开始）
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="c1"></span>	<span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">UserSrvClient</span><span class="p">.</span><span class="nf">GetUserList</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">proto</span><span class="p">.</span><span class="nx">PageIngo</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">		<span class="nx">PageNum</span><span class="p">:</span>  <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">		<span class="nx">PageSize</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;查询用户列表失败&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">		<span class="nf">HandleGrpcErrorToHttp</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">datum</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rsp</span><span class="p">.</span><span class="nx">Data</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">		<span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">		<span class="nx">data</span><span class="p">[</span><span class="s">&#34;id&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">Id</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">		<span class="nx">data</span><span class="p">[</span><span class="s">&#34;nickname&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">Nickname</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">		<span class="nx">data</span><span class="p">[</span><span class="s">&#34;gender&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">Gender</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">		<span class="nx">data</span><span class="p">[</span><span class="s">&#34;email&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">Email</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">		<span class="nx">data</span><span class="p">[</span><span class="s">&#34;role&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datum</span><span class="p">.</span><span class="nx">Role</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">		<span class="nx">result</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">    <span class="c1">// 包装响应
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="c1"></span>	<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">		<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">result</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="初始化路由">初始化路由<a class="anchor ms-1" href="#初始化路由"><i class="fas fa-link"></i></a></h3>
<p>在<code>shop\api\user-api\router</code>中新建文件<code>user.go</code>初始化user的路由</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">router</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/api&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kd">func</span> <span class="nf">InitUserRouter</span><span class="p">(</span><span class="nx">router</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="nx">userRouter</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">		<span class="nx">userRouter</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;list&#34;</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">GetUserList</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在全局路由中注册<code>shop\api\user-api\initialize\router.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">initialize</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="nx">router2</span> <span class="s">&#34;github.com/jimyag/shop/api/user/router&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kd">func</span> <span class="nf">Routers</span><span class="p">()</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="nx">router</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">apiGroup</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/user/v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="nx">router2</span><span class="p">.</span><span class="nf">InitUserRouter</span><span class="p">(</span><span class="nx">apiGroup</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="k">return</span> <span class="nx">router</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="测试运行">测试运行<a class="anchor ms-1" href="#测试运行"><i class="fas fa-link"></i></a></h3>
<p><code>shop\api\user-api\main.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;go.uber.org/zap&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/initialize&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="nx">initialize</span><span class="p">.</span><span class="nf">InitLogger</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nx">initialize</span><span class="p">.</span><span class="nf">InitSrvConn</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="c1">// 初始化router
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>	<span class="nx">router</span> <span class="o">:=</span> <span class="nx">initialize</span><span class="p">.</span><span class="nf">Routers</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;127.0.0.1:%d&#34;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="nx">zap</span><span class="p">.</span><span class="nf">L</span><span class="p">().</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;启动失败&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>现在我们第一个http的接口就已经写好了，其余的http的接口均在<a href="https://github.com/jimyag/shop/tree/master/api/user-api" target="_blank" rel="noopener noreferrer">user-api</a></p>
<h2 id="使用viper加载配置文件">使用viper加载配置文件<a class="anchor ms-1" href="#使用viper加载配置文件"><i class="fas fa-link"></i></a></h2>
<p>在上述内容中，我们看到许多的配置文件都是写死的，万一我们的配置的端口发送变动，这时候就要挨个改配置文件，很是麻烦，我们可以将这些配置写入到指定的配置文件中去。</p>
<p>在<code>shop\api\user-api\config\config.go</code>中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">config</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1">// user grpc 服务的配置
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">UserSrvConfig</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="nx">Host</span>     <span class="kt">string</span> <span class="s">`mapstructure:&#34;host&#34;`</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="nx">HostPort</span> <span class="kt">int</span>    <span class="s">`mapstructure:&#34;host-port&#34;`</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="nx">Name</span>     <span class="kt">string</span> <span class="s">`mapstructure:&#34;name&#34;`</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1">// 用户http服务的配置
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerInfo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">Name</span>       <span class="kt">string</span>        <span class="s">`mapstructure:&#34;name&#34;`</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="nx">Port</span>       <span class="kt">int</span>           <span class="s">`mapstructure:&#34;port&#34;`</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="nx">UserSrv</span>    <span class="nx">UserSrvConfig</span> <span class="s">`mapstructure:&#34;user-srv&#34;`</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在<code>shop\api\user-api\config-debug.yaml</code>和<code>shop\api\user-api\config-release.yaml</code>中写入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;user-api&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8021</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nt">user-srv</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;192.168.0.2&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">  </span><span class="nt">host-port</span><span class="p">:</span><span class="w"> </span><span class="m">50051</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;user-srv&#34;</span><span class="w">
</span></span></span></code></pre></div><p>这里将开发环境和线上环境进行隔离开，可以通过读取环境变量来判断是开发环境还是线上环境，这里开发环境和线上环境的配置是相同的。</p>
<p>在全局变量文件<code>shop\api\user-api\global\global.go</code>中添加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">ServerConfig</span>     <span class="o">*</span><span class="nx">config</span><span class="p">.</span><span class="nx">ServerInfo</span>
</span></span></code></pre></div><p>初始化加载配置文件<code>shop\api\user-api\initialize\config.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">initialize</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;github.com/spf13/viper&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/spf13/viper/remote&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;go.uber.org/zap&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1">// 加载环境变量
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">getEnvBool</span><span class="p">(</span><span class="nx">env</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="nx">viper</span><span class="p">.</span><span class="nf">AutomaticEnv</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="k">return</span> <span class="nx">viper</span><span class="p">.</span><span class="nf">GetBool</span><span class="p">(</span><span class="nx">env</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1">// LoadConfigInfo 加载本地的 consul 文件
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">LoadConfigInfo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="c1">// 默认是读取线上环境的配置
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1"></span>	<span class="nx">configFilePath</span> <span class="o">:=</span> <span class="s">&#34;config-release.yaml&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="c1">// 如果环境变量中&#34;shop_debug&#34;为true就读取开发环境配置
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">getEnvBool</span><span class="p">(</span><span class="s">&#34;shop_debug&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="nx">configFilePath</span> <span class="o">:=</span> <span class="s">&#34;config-debug.yaml&#34;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="nx">v</span> <span class="o">:=</span> <span class="nx">viper</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">v</span><span class="p">.</span><span class="nf">SetConfigFile</span><span class="p">(</span><span class="nx">configFilePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">ReadInConfig</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;加载配置文件失败.....&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">			<span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">			<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">configFilePath</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl">	<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;配置加载成功....&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">		<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">configFilePath</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">global</span><span class="p">.</span><span class="nx">ServerConfig</span> <span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;解析配置文件失败....&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">			<span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">			<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">configFilePath</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;成功加载配置文件&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">		<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">configFilePath</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">		<span class="nx">zap</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="s">&#34;content&#34;</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">ServerConfig</span> <span class="p">),</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">    <span class="c1">// 这里做的是监听配置文件的变化，变化之后的操作。
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="c1"></span>	<span class="nx">v</span><span class="p">.</span><span class="nf">WatchConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">	<span class="nx">v</span><span class="p">.</span><span class="nf">OnConfigChange</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">in</span> <span class="nx">fsnotify</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;配置文件产生变化....&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">			<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">			<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">configFilePath</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">
</span></span><span class="line"><span class="ln">57</span><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">ReadInConfig</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">			<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;修改的配置文件字段出错&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">				<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;field&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">				<span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">			<span class="p">)</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">global</span><span class="p">.</span><span class="nx">ServerConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">			<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;解析配置文件出错&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">				<span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;field&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">				<span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">			<span class="p">)</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;配置文件内容&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="s">&#34;config&#34;</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">ServerConfig</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>现在我们就可以将用到的所有的配置都可以使用<code>global.ServerConfig .XXX</code>来代替了。这里的替换不做过多说明。</p>
<p>在<code>shop\api\user-api\main.go</code>中记得要初始化全局的配置文件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">initialize</span><span class="p">.</span><span class="nf">InitLogger</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1">// 变更的从这里开始
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span><span class="nx">initialize</span><span class="p">.</span><span class="nf">LoadConfigInfo</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1">// 这里结束
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"></span><span class="nx">initialize</span><span class="p">.</span><span class="nf">InitSrvConn</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="表单数据验证">表单数据验证<a class="anchor ms-1" href="#表单数据验证"><i class="fas fa-link"></i></a></h2>
<p>在写登录接口之前我们首先要处理表单验证，表单验证可以提前帮助我们优雅判断传入的数据是否合法。</p>
<h3 id="定义验证结构体">定义验证结构体<a class="anchor ms-1" href="#定义验证结构体"><i class="fas fa-link"></i></a></h3>
<p>首先我们<code>shop\api\user-api\model\request\user.go</code>新建使用邮件和密码登录参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">package</span> <span class="nx">request</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">// 这里的validate标签就代表是要进行验证，label是我们自定义的标签，可以在之后的翻译中使用。
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PasswordLoginForm</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">	<span class="nx">Email</span>    <span class="kt">string</span> <span class="s">`json:&#34;email&#34; validate:&#34;required,email&#34; label:&#34;邮件&#34;`</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">	<span class="nx">Password</span> <span class="kt">string</span> <span class="s">`json:&#34;password&#34; validate:&#34;required,min=6,max=20&#34; label:&#34;您的密码&#34;`</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="初始化翻译器">初始化翻译器<a class="anchor ms-1" href="#初始化翻译器"><i class="fas fa-link"></i></a></h3>
<p>在使用表单验证的时候需要用到<code>Translator和validator.Validate</code>我们在全局变量<code>shop\api\user-api\global\global.go</code>中声明他们</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="nx">ut</span> <span class="s">&#34;github.com/go-playground/universal-translator&#34;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">	<span class="s">&#34;github.com/go-playground/validator/v10&#34;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="kd">var</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="c1">// 增加的 其余的省略
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"></span>    <span class="nx">Trans</span>            <span class="nx">ut</span><span class="p">.</span><span class="nx">Translator</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">	<span class="nx">Validate</span>         <span class="o">*</span><span class="nx">validator</span><span class="p">.</span><span class="nx">Validate</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>由于在做验证的时候我们首先要初始化这两个全局变量，在<code>shop\api\user-api\initialize\validator.go</code>初始化包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">initialize</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;reflect&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/go-playground/locales/zh&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="nx">ut</span> <span class="s">&#34;github.com/go-playground/universal-translator&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="s">&#34;github.com/go-playground/validator/v10&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="nx">zhtranslations</span> <span class="s">&#34;github.com/go-playground/validator/v10/translations/zh&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="kd">func</span> <span class="nf">InitValidateAndTrans</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="nx">global</span><span class="p">.</span><span class="nx">Validate</span> <span class="p">=</span> <span class="nx">validator</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="c1">// 第一个是备用翻译，后面的才是主要的翻译
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>	<span class="nx">uni</span> <span class="o">:=</span> <span class="nx">ut</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">zh</span><span class="p">.</span><span class="nf">New</span><span class="p">(),</span> <span class="nx">zh</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="c1">// 拿到中文的翻译器
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span>	<span class="nx">global</span><span class="p">.</span><span class="nx">Trans</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">uni</span><span class="p">.</span><span class="nf">GetTranslator</span><span class="p">(</span><span class="s">&#34;zh&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;得到翻译器失败...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="c1">// 将翻译器注册
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">zhtranslations</span><span class="p">.</span><span class="nf">RegisterDefaultTranslations</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Validate</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Trans</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;注册翻译器失败......&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="c1">// 这里是我们自定义的标签名的翻译，可以更好展示错误信息，
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span>    <span class="c1">// 比如定义一个结构体字段，role 权限，如果不定义自己标签进行说明，对看的人不友好。
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span>	<span class="nx">global</span><span class="p">.</span><span class="nx">Validate</span><span class="p">.</span><span class="nf">RegisterTagNameFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">field</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">StructField</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="nx">label</span> <span class="o">:=</span> <span class="nx">field</span><span class="p">.</span><span class="nx">Tag</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;label&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">		<span class="k">return</span> <span class="nx">label</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">	<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;翻译器注册成功......&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="验证逻辑">验证逻辑<a class="anchor ms-1" href="#验证逻辑"><i class="fas fa-link"></i></a></h3>
<p>在初始翻译相关的之后，我们就可以验证了。在<code>shop\api\user-api\util\validate\validator.go</code>中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">validate</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;github.com/go-playground/validator/v10&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1">// 由于我们传进来的都是结构体，所有我们就用结构体进行验证
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Validate</span><span class="p">(</span><span class="nx">data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Validate</span><span class="p">.</span><span class="nf">Struct</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="c1">// 如果有错误，就将他断言为validator的错误
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span>		<span class="nx">errs</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">validator</span><span class="p">.</span><span class="nx">ValidationErrors</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">		<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="c1">// 将多余的信息去掉
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>			<span class="nx">errMsg</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fieldError</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">errs</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">				<span class="nx">errMsg</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">errMsg</span><span class="p">,</span> <span class="nx">fieldError</span><span class="p">.</span><span class="nf">Translate</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Trans</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">			<span class="k">return</span> <span class="nx">errMsg</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">            <span class="k">return</span> <span class="nx">errs</span><span class="p">,</span><span class="nx">err</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="如何使用">如何使用<a class="anchor ms-1" href="#如何使用"><i class="fas fa-link"></i></a></h3>
<p>在<code>shop\api\user-api\api\user.go</code>继续写入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 省略其余的
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="kn">import</span>	<span class="s">&#34;github.com/jimyag/shop/api/user/util/validate&#34;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kd">func</span> <span class="nf">PasswordLogin</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="nx">passwordLoginForm</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">PasswordLoginForm</span><span class="p">{}</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">passwordLoginForm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;ssss&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c1">// 获得传来的数据之后，直接验证
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span>	<span class="nx">msg</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">validate</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="nx">passwordLoginForm</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">			<span class="s">&#34;error&#34;</span><span class="p">:</span> <span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="o">...</span><span class="p">.</span> <span class="nx">省略其余的逻辑</span><span class="err">，</span><span class="nx">之后再写</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">			<span class="s">&#34;msg&#34;</span><span class="p">:</span> <span class="s">&#34;成功&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="封装统一的响应">封装统一的响应<a class="anchor ms-1" href="#封装统一的响应"><i class="fas fa-link"></i></a></h3>
<p>在之前我们的响应都是通过<code>ctx.JSON(http.StatusOK, gin.H{&quot;msg&quot;: &quot;成功&quot;,})</code>来实现的，这里我们将其封装一下。</p>
<p>在<code>shop\api\user-api\model\response\common.go</code>封装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">response</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1">// 响应的结构体
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="nx">Code</span> <span class="kt">int</span>         <span class="s">`json:&#34;code&#34;`</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">Data</span> <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;data&#34;`</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="nx">Msg</span>  <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;msg&#34;`</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1">// 成功或者失败
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="nx">SUCCESS</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nx">ERROR</span>   <span class="p">=</span> <span class="mi">500</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="kd">var</span> <span class="nx">codeMsg</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="nx">SUCCESS</span><span class="p">:</span> <span class="s">&#34;成功&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="nx">ERROR</span><span class="p">:</span>   <span class="s">&#34;失败&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="kd">func</span> <span class="nf">getErrMsg</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="k">return</span> <span class="nx">codeMsg</span><span class="p">[</span><span class="nx">code</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="c1">// 无论成功或者失败都是http.StatusOK
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">result</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">data</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">msg</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">	<span class="nx">context</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">Response</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">		<span class="nx">code</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="nx">data</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">		<span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="kd">func</span> <span class="nf">Ok</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="nf">result</span><span class="p">(</span><span class="nx">SUCCESS</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">getErrMsg</span><span class="p">(</span><span class="nx">SUCCESS</span><span class="p">),</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="kd">func</span> <span class="nf">Fail</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">	<span class="nf">result</span><span class="p">(</span><span class="nx">ERROR</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">getErrMsg</span><span class="p">(</span><span class="nx">ERROR</span><span class="p">),</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="kd">func</span> <span class="nf">OkWithData</span><span class="p">(</span><span class="nx">data</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="nf">result</span><span class="p">(</span><span class="nx">SUCCESS</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">getErrMsg</span><span class="p">(</span><span class="nx">SUCCESS</span><span class="p">),</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="o">...</span><span class="p">.</span> <span class="nx">省略</span>
</span></span></code></pre></div><p>对于处理grpc的错误的方法也进行封装</p>
<p><code>shop\api\user-api\util\handle_grpc_error\handle_grpc_error.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">handle_grpc_error</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc/status&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/model/response&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="kd">func</span> <span class="nf">HandleGrpcErrorToHttp</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">FromError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">		<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">Message</span><span class="p">(),</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>以使用邮箱和密码登录为例子，我们可以这样实现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">func</span> <span class="nf">PasswordLogin</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">	<span class="nx">passwordLoginForm</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">PasswordLoginForm</span><span class="p">{}</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">passwordLoginForm</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="nx">msg</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">validate</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="nx">passwordLoginForm</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">		<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">UserSrvClient</span><span class="p">.</span><span class="nf">GetUserByEmail</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">proto</span><span class="p">.</span><span class="nx">EmailRequest</span><span class="p">{</span><span class="nx">Email</span><span class="p">:</span> <span class="nx">passwordLoginForm</span><span class="p">.</span><span class="nx">Email</span><span class="p">})</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">		<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;用户不存在&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="nx">checkP</span> <span class="o">:=</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">PasswordCheckInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		<span class="nx">Password</span><span class="p">:</span>          <span class="nx">passwordLoginForm</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="nx">EncryptedPassword</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nf">GetPassword</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="nx">password</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">UserSrvClient</span><span class="p">.</span><span class="nf">CheckPassword</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">checkP</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;登录失败&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">password</span><span class="p">.</span><span class="nf">GetSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">		<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;邮箱或密码错误&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="c1">// todo 没有完成
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span>	<span class="nx">response</span><span class="p">.</span><span class="nf">OkWithMsg</span><span class="p">(</span><span class="s">&#34;登录成功&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>其余的响应可以一起改了</p>
<h2 id="paseto认证">PASETO认证<a class="anchor ms-1" href="#paseto认证"><i class="fas fa-link"></i></a></h2>
<p>在登录的时候，我们需要保存用户的状态，这里使用PASETO进行认证。用户登录成功之后就颁发token</p>
<p>对于用户的状态我们要保存<code>uid,role</code>，除此之外还有过期签发时间，过期时间。</p>
<p>我们声明载体<code>shop\api\user-api\util\paseto\payload.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">paseto</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1">// Different types of error returned by the VerifyToken function
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="nx">ErrInvalidToken</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;token is invalid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">ErrExpiredToken</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;token has expired&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="kd">type</span> <span class="nx">Payload</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="nx">IssuedAt</span>  <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="nx">ExpiredAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nx">UID</span>       <span class="kt">int32</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">	<span class="nx">Nickname</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="nx">Role</span>      <span class="kt">int32</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1">// NewPayload creates a new token payload with a specific username and duration
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewPayload</span><span class="p">(</span><span class="nx">uid</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">nickname</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">role</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Payload</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="nx">payload</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Payload</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">		<span class="nx">UID</span><span class="p">:</span>      <span class="nx">uid</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">		<span class="nx">Nickname</span><span class="p">:</span> <span class="nx">nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">		<span class="nx">Role</span><span class="p">:</span>     <span class="nx">role</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">	<span class="k">return</span> <span class="nx">payload</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="c1">// Valid checks if the token payload is valid or not
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">payload</span> <span class="o">*</span><span class="nx">Payload</span><span class="p">)</span> <span class="nf">Valid</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">	<span class="k">if</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">After</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">ExpiredAt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">		<span class="k">return</span> <span class="nx">ErrExpiredToken</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>PASETO的使用很简单只要两个方法就能实现验证。<code>shop\api\user-api\util\paseto\paseto.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">paseto</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;crypto/ed25519&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;github.com/o1egl/paseto&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">// PasetoMaker is a PASETO token maker
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PasetoMaker</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="nx">pastor</span>     <span class="o">*</span><span class="nx">paseto</span><span class="p">.</span><span class="nx">V2</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="nx">privateKey</span> <span class="nx">ed25519</span><span class="p">.</span><span class="nx">PrivateKey</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="nx">publicKey</span>  <span class="nx">ed25519</span><span class="p">.</span><span class="nx">PublicKey</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="nx">duration</span>   <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1">// NewPasetoMaker creates a new PasetoMaker
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewPasetoMaker</span><span class="p">(</span><span class="nx">privateKey</span> <span class="nx">ed25519</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">,</span> <span class="nx">publicKey</span> <span class="nx">ed25519</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">,</span> <span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">PasetoMaker</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="nx">maker</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">PasetoMaker</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">		<span class="nx">pastor</span><span class="p">:</span>     <span class="nx">paseto</span><span class="p">.</span><span class="nf">NewV2</span><span class="p">(),</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">privateKey</span><span class="p">:</span> <span class="nx">privateKey</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">		<span class="nx">publicKey</span><span class="p">:</span>  <span class="nx">publicKey</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">		<span class="nx">duration</span><span class="p">:</span>   <span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="k">return</span> <span class="nx">maker</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1">// CreateToken creates a new token for a specific username and duration
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">maker</span> <span class="o">*</span><span class="nx">PasetoMaker</span><span class="p">)</span> <span class="nf">CreateToken</span><span class="p">(</span><span class="nx">payload</span> <span class="o">*</span><span class="nx">Payload</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="nx">payload</span><span class="p">.</span><span class="nx">IssuedAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">	<span class="nx">payload</span><span class="p">.</span><span class="nx">ExpiredAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="nx">maker</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">	<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">maker</span><span class="p">.</span><span class="nx">pastor</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="nx">maker</span><span class="p">.</span><span class="nx">privateKey</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="k">return</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="c1">// VerifyToken checks if the token is valid or not
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">maker</span> <span class="o">*</span><span class="nx">PasetoMaker</span><span class="p">)</span> <span class="nf">VerifyToken</span><span class="p">(</span><span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Payload</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">	<span class="nx">payload</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Payload</span><span class="p">{}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">maker</span><span class="p">.</span><span class="nx">pastor</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">maker</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrInvalidToken</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="k">if</span> <span class="nx">payload</span><span class="p">.</span><span class="nf">Valid</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">	<span class="k">return</span> <span class="nx">payload</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这里使用的是一种非对称加密的方式，私钥负责颁发，公钥负责校验。</p>
<p>从配置文件加载公钥私钥以及过期时间省略，由于我们一直要用到签发token和校验token的，把它加到全局变量中。</p>
<p>之后在登录的逻辑中<code>shop\api\user-api\api\user.go:func PasswordLogin(ctx *gin.Context)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl">	<span class="c1">// todo 没有完成
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span>	<span class="nx">payload</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">paseto</span><span class="p">.</span><span class="nf">NewPayload</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Nickname</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Role</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">PasetoMaker</span><span class="p">.</span><span class="nf">CreateToken</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">		<span class="nx">global</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;创建Token失败&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;登录失败，请稍后&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="nx">res</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="nx">res</span><span class="p">[</span><span class="s">&#34;token&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">token</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="nx">response</span><span class="p">.</span><span class="nf">OkWithDataMsg</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="s">&#34;登录成功&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></span></code></pre></div><p>这时候，对于获取用户信息的请求，我们就需要做认证了。</p>
<p>使用中间件进行拦截。</p>
<p><code>shop\api\user-api\middlewares\paseto.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">middlewares</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/global&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/model/response&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	<span class="s">&#34;github.com/jimyag/shop/api/user/util/paseto&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="kd">func</span> <span class="nf">Paseto</span><span class="p">()</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="c1">// 使用的是bearer token的格式
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>		<span class="nx">tokenHeader</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="k">if</span> <span class="nx">tokenHeader</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">			<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;token 无效&#34;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">			<span class="nx">context</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="c1">// 解析
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span>		<span class="nx">check</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">SplitN</span><span class="p">(</span><span class="nx">tokenHeader</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">check</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#34;Bearer&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">			<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;token 格式错误&#34;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">			<span class="nx">context</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">		<span class="nx">payload</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">PasetoMaker</span><span class="p">.</span><span class="nf">VerifyToken</span><span class="p">(</span><span class="nx">check</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">		<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">paseto</span><span class="p">.</span><span class="nx">ErrInvalidToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">			<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;token 格式错误&#34;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">			<span class="nx">context</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">paseto</span><span class="p">.</span><span class="nx">ErrExpiredToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">			<span class="nx">response</span><span class="p">.</span><span class="nf">FailWithMsg</span><span class="p">(</span><span class="s">&#34;token 过期&#34;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">			<span class="nx">context</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">		<span class="nx">context</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;payload&#34;</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></div></div>
  <div class="card-footer"><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev">
    <i class="fas fa-fw fa-chevron-circle-down post-prev-icon" data-fa-transform="rotate-90"></i>
    <a href="/posts/5f073a52/">从0到1实现完整的微服务框架-项目介绍
</a>
  </div><div class="post-nav post-next">
    <a href="/posts/5763d21a/">从0到1实现完整的微服务框架-服务注册、发现、配置中心
</a>
    <i class="fas fa-fw fa-chevron-circle-down post-next-icon" data-fa-transform="rotate-270"></i>
  </div></div></div>
</article><div class="post-copyright mb-3 row card component" id="post-copyright">
    <div class="card-header">
        <h2 class="card-title">版权</h2>
    </div>
    <div class="card-body"><a class="d-flex align-items-center flex-column" target="_blank" rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">
  <span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
  CC BY-NC-ND 4.0 
</a>


    </div>
</div><section class="related-posts row card component">
    <div class="card-header">
      <h2 class="card-title">相关文章</h2>
    </div>
    <div class="card-body">
      <ul class="post-list"><li>
          <a href="/posts/5f073a52/">从0到1实现完整的微服务框架-项目介绍
</a>
          <span class="float-end post-date">2022-03-25
</span>
        </li><li>
          <a href="/posts/acba46c5/">从单体应用到微服务
</a>
          <span class="float-end post-date">2022-03-24
</span>
        </li><li>
          <a href="/posts/3259ac99/">GRPC-四种模式实践
</a>
          <span class="float-end post-date">2022-03-09
</span>
        </li><li>
          <a href="/posts/11a90fe7/">Go中rpc包的使用
</a>
          <span class="float-end post-date">2022-03-25
</span>
        </li><li>
          <a href="/posts/8d24f484/">RPC基础介绍
</a>
          <span class="float-end post-date">2022-03-25
</span>
        </li></ul>
    </div>
  </section></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container d-flex flex-column">
    
    <div class="card row text-center profile component">
  <div class="card-body">
    <div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt="jimyag" src="/images/spider-man.jpg" loading="lazy" data-viewer-invisible
     width="556" height="559"
     />
</picture>
</div>
    <div class="col-12 profile-meta"><div class="profile-name">jimyag</div><div class="profile-bio">Gopher</div><div class="profile-location"><i class="fas fa-fw fa-map-marker-alt"></i>Shanghai</div><div class="profile-about"><i class="fas fa-fw fa-user"></i><a href="/about/">About</a></div><nav class="social-links nav justify-content-center"><a class="nav-link social-link" href="mailto:i@jimyag.cn" title="Email">
      <i class="fas fa-fw fa-2x fa-envelope"></i>
    </a><a class="nav-link social-link" target="_blank" href="https://github.com/jimyag" title="GitHub" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-github"></i>
      </a><a class="nav-link social-link" target="_blank" href="/index.xml" title="RSS" rel="noopener noreferrer">
    <i class="fas fa-fw fa-2x fa-rss"></i>
  </a></nav>
</div>
  </div>
</div>
<div class="post-toc row mb-4 card component" id="postTOC">
  <div class="card-header">
    <h2 class="card-title">目录</h2>
  </div>
  <div class="card-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#开始">开始</a></li>
    <li><a href="#用户表结构">用户表结构</a>
      <ul>
        <li><a href="#创建user数据库">创建user数据库</a></li>
        <li><a href="#数据库迁移">数据库迁移</a></li>
        <li><a href="#生成curd代码">生成curd代码</a></li>
        <li><a href="#测试连接数据库">测试连接数据库</a></li>
        <li><a href="#测试生成的curd代码">测试生成的curd代码</a></li>
        <li><a href="#关于用户密码的加密">关于用户密码的加密</a></li>
      </ul>
    </li>
    <li><a href="#定义用户proto">定义用户proto</a></li>
    <li><a href="#实现grpc用户的相关接口">实现grpc用户的相关接口</a>
      <ul>
        <li><a href="#实现grpc的接口">实现grpc的接口</a></li>
        <li><a href="#测试grpc接口">测试grpc接口</a></li>
        <li><a href="#问题">问题</a></li>
      </ul>
    </li>
    <li><a href="#实现用户服务的web层服务">实现用户服务的web层服务</a>
      <ul>
        <li><a href="#使用全局的zaplogger">使用全局的zaplogger</a></li>
        <li><a href="#连接到grpc的服务端">连接到grpc的服务端</a></li>
        <li><a href="#编写第一个http接口">编写第一个http接口</a></li>
        <li><a href="#初始化路由">初始化路由</a></li>
        <li><a href="#测试运行">测试运行</a></li>
      </ul>
    </li>
    <li><a href="#使用viper加载配置文件">使用viper加载配置文件</a></li>
    <li><a href="#表单数据验证">表单数据验证</a>
      <ul>
        <li><a href="#定义验证结构体">定义验证结构体</a></li>
        <li><a href="#初始化翻译器">初始化翻译器</a></li>
        <li><a href="#验证逻辑">验证逻辑</a></li>
        <li><a href="#如何使用">如何使用</a></li>
        <li><a href="#封装统一的响应">封装统一的响应</a></li>
      </ul>
    </li>
    <li><a href="#paseto认证">PASETO认证</a></li>
  </ul>
</nav>
  </div>
</div><section class="recent-posts row card component">
  <div class="card-header">
    <h2 class="card-title">最近文章</h2>
  </div>
  <div class="card-body">
    <ul class="post-list"><li>
        <a href="/posts/6db6b747/">Google MapReduce翻译
</a>
      </li><li>
        <a href="/posts/f6adfb46/">6.824 Spring 2020 Lab1 MapReduce文档翻译
</a>
      </li><li>
        <a href="/posts/14976c16/">我的notion规划
</a>
      </li><li>
        <a href="/posts/9c78a390/">Git开发分支落后远程主分支
</a>
      </li><li>
        <a href="/posts/0f0b28a1/">Oh My Zsh进入git目录卡顿
</a>
      </li></ul>
  </div>
</section><section class="series-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/series">专栏</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/series/leetcode/" class="badge rounded post-taxonomy" title="leetcode">
            leetcode<span class="badge badge-sm text-white bg-accent ms-1">32</span></a><a href="/series/%E4%BB%8E0%E5%88%B01%E5%AE%9E%E7%8E%B0%E5%AE%8C%E6%95%B4%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/" class="badge rounded post-taxonomy" title="从0到1实现完整的微服务框架">
            从0到1实现完整的微服务框架<span class="badge badge-sm text-white bg-accent ms-1">12</span></a><a href="/series/%E7%89%9B%E5%AE%A2top101/" class="badge rounded post-taxonomy" title="牛客TOP101">
            牛客TOP101<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/series/mit6.824/" class="badge rounded post-taxonomy" title="MIT6.824">
            MIT6.824<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/series/vim/" class="badge rounded post-taxonomy" title="vim">
            vim<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div>
      </div>
    </section><section class="categories-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/categories">分类</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/categories/leetcode/" class="badge rounded post-taxonomy" title="LeetCode">
            LeetCode<span class="badge badge-sm text-white bg-accent ms-1">32</span></a><a href="/categories/%E6%95%99%E7%A8%8B/" class="badge rounded post-taxonomy" title="教程">
            教程<span class="badge badge-sm text-white bg-accent ms-1">9</span></a><a href="/categories/go/" class="badge rounded post-taxonomy" title="Go">
            Go<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/categories/%E7%AE%97%E6%B3%95/" class="badge rounded post-taxonomy" title="算法">
            算法<span class="badge badge-sm text-white bg-accent ms-1">4</span></a><a href="/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" class="badge rounded post-taxonomy" title="编译原理">
            编译原理<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/categories/%E8%B8%A9%E5%9D%91/" class="badge rounded post-taxonomy" title="踩坑">
            踩坑<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href="/categories/hexo/" class="badge rounded post-taxonomy" title="Hexo">
            Hexo<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/categories/web/" class="badge rounded post-taxonomy" title="Web">
            Web<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/categories/yolov5/" class="badge rounded post-taxonomy" title="YOLOV5">
            YOLOV5<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="badge rounded post-taxonomy" title="计算机网络">
            计算机网络<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href="/categories" class="badge rounded post-taxonomy" title='全部'>
          全部
          <span class="badge badge-sm text-white bg-accent ms-1">22</span>
        </a></div>
      </div>
    </section><section class="tags-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="/tags">标签</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2"><a href="/tags/%E6%95%99%E7%A8%8B/" class="badge rounded post-taxonomy" title="教程">
            教程<span class="badge badge-sm text-white bg-accent ms-1">29</span></a><a href="/tags/%E4%B8%AD%E7%AD%89/" class="badge rounded post-taxonomy" title="中等">
            中等<span class="badge badge-sm text-white bg-accent ms-1">14</span></a><a href="/tags/%E7%AE%80%E5%8D%95/" class="badge rounded post-taxonomy" title="简单">
            简单<span class="badge badge-sm text-white bg-accent ms-1">13</span></a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="badge rounded post-taxonomy" title="微服务">
            微服务<span class="badge badge-sm text-white bg-accent ms-1">12</span></a><a href="/tags/grpc/" class="badge rounded post-taxonomy" title="gRPC">
            gRPC<span class="badge badge-sm text-white bg-accent ms-1">10</span></a><a href="/tags/go/" class="badge rounded post-taxonomy" title="Go">
            Go<span class="badge badge-sm text-white bg-accent ms-1">9</span></a><a href="/tags/%E6%A8%A1%E6%8B%9F/" class="badge rounded post-taxonomy" title="模拟">
            模拟<span class="badge badge-sm text-white bg-accent ms-1">7</span></a><a href="/tags/%E5%A4%8D%E4%B9%A0%E8%B5%84%E6%96%99/" class="badge rounded post-taxonomy" title="复习资料">
            复习资料<span class="badge badge-sm text-white bg-accent ms-1">6</span></a><a href="/tags/%E5%9B%B0%E9%9A%BE/" class="badge rounded post-taxonomy" title="困难">
            困难<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="/tags/%E7%AE%97%E6%B3%95/" class="badge rounded post-taxonomy" title="算法">
            算法<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href="/tags" class="badge rounded post-taxonomy" title='全部'>
          全部
          <span class="badge badge-sm text-white bg-accent ms-1">81</span>
        </a></div>
      </div>
    </section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav justify-content-center mb-2"><a class="nav-link social-link" href="mailto:i@jimyag.cn" title="Email">
      <i class="fas fa-fw fa-2x fa-envelope"></i>
    </a><a class="nav-link social-link" target="_blank" href="https://github.com/jimyag" title="GitHub" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-github"></i>
      </a><a class="nav-link social-link" target="_blank" href="/index.xml" title="RSS" rel="noopener noreferrer">
    <i class="fas fa-fw fa-2x fa-rss"></i>
  </a></nav>
<div class="copyright mb-2">
  Copyright © 2019-2022 jimyag. All Rights Reserved. 
</div>
<div class="powered-by mb-2">
  <a href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferrer">陕ICP备2020018182号-1 </a>
</div></footer>
<script src="/assets/main/bundle.min.b5532796c3cf4f82f5b0254d4790694b9a7766fb69b6fc6bd76c68a1946df067.js" integrity="sha256-tVMnlsPPT4L1sCVNR5BpS5p3Zvtptvxr12xooZRt8Gc=" crossorigin="anonymous" defer></script><script src="/assets/icons/bundle.min.dfcbe757302616d36e2f117823c56facf382204bf3ab9ea29dffd5f2fc56bdef.js" integrity="sha256-38vnVzAmFtNuLxF4I8VvrPOCIEvzq56inf/V8vxWve8=" crossorigin="anonymous" defer></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('\/service-worker.min.js').then(function(reg) {
      console.log('Successfully registered service worker', reg);
    }).catch(function(err) {
      console.warn('Error whilst registering service worker', err);
    });
  });
}
</script><script src="/assets/viewer/bundle.min.0ec873e11f754ed0ad81a68dca8496e24286666354e9c7c11ff339c390f086f0.js" integrity="sha256-Dshz4R91TtCtgaaNyoSW4kKGZmNU6cfBH/M5w5DwhvA=" crossorigin="anonymous" defer></script>
</body>
</html>
